<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://api-maps.yandex.ru/2.1/?apikey=ff200a7d-d886-40bb-8be8-273ce59a7812&lang=ru_RU"
    type="text/javascript"></script>
  <title>AgMap</title>
</head>

<body>
  <header></header>
  <main>
    <h1>Дома, входящие в окргуг</h1>
    <table id="list">
      <tr>
        <th>Улица</th>
        <th>Дом</th>
        <th>Номер дома</th>
        <th>Кол-во квартир</th>
      </tr>
    </table>
    <h1>Размещение на карте</h1>
    <div id="map" style="width: 100%; height: 600px;"></div>
  </main>
  <script>
    "use strict";

    //ff200a7d-d886-40bb-8be8-273ce59a7812 
    //ba994d74-1acb-46d7-a398-f7c5eceaa44d - t-com



    const city = 'Нижний Новгород';

    const luganskaya = [
      {
        street: 'Луганская',
        nr: '1',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '2A',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '3',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '4A',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '5',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '6',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Луганская',
        nr: '7',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
    ]

    const batumskaya = [
      {
        street: 'Батумская',
        nr: '17',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Батумская',
        nr: '18',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
    ]

    const vologdina = [
      {
        street: 'Вологдина',
        nr: '1А',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Вологдина',
        nr: '1Б',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'Вологдина',
        nr: '1',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      // {
      //   street: 'Вологдина',
      //   nr: '3',
      //   appartments: 170,
      //   entrances: 2,
      //   coveredTimes: 1,
      //   remarks: '',
      // },
      // {
      //   street: 'Вологдина',
      //   nr: '4',
      //   appartments: 170,
      //   entrances: 2,
      //   coveredTimes: 1,
      //   remarks: '',
      // },
      // {
      //   street: 'Вологдина',
      //   nr: '5',
      //   appartments: 170,
      //   entrances: 2,
      //   coveredTimes: 1,
      //   remarks: '',
      // },

    ]

    const gagarina = [
//       {
//         street: 'проспект Гагарина',
//         nr: '102',
//         appartments: 170,
//         entrances: 2,
//         coveredTimes: 1,
//         remarks: '',
//       },
//       {
//         street: 'проспект Гагарина',
//         nr: '104',
//         appartments: 170,
//         entrances: 2,
//         coveredTimes: 1,
//         remarks: '',
//       },
      {
        street: 'проспект Гагарина',
        nr: '106',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '108',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '110',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '110А',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },

      {
        street: 'проспект Гагарина',
        nr: '110Б',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '112',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '112А',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '114',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '118',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '122',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '124/122',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '126',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '128',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },
      {
        street: 'проспект Гагарина',
        nr: '130',
        appartments: 170,
        entrances: 2,
        coveredTimes: 1,
        remarks: '',
      },


    ]

    let myMap;
    let lastHouse = false;

    ymaps.ready(init)

    function init() {
      myMap = new ymaps.Map(
        "map",
        {
          center: [56.273, 43.979],
          zoom: 15,
          controls: [
            "zoomControl", // ?
            "rulerControl", // ?
            "typeSelector", // ?
          ],
        },
        {
          supperssMapOpenBlock: true,
        }
      );

      // luganskaya.forEach((item, index) => {
      //   if (index === (luganskaya.length - 1)) {
      //     lastHouse = true;
      //   }
      //   geocodeHouse(item);
      // });
      // batumskaya.forEach((item, index) => {
      //   if (index === (luganskaya.length - 1)) {
      //     lastHouse = true;
      //   }
      //   geocodeHouse(item);
      // });
//       vologdina.forEach((item, index) => {
//         if (index === (luganskaya.length - 1)) {
//           lastHouse = true;
//         }
//         geocodeHouse(item);
//       });
      gagarina.forEach((item, index) => {
        if (index === (luganskaya.length - 1)) {
          lastHouse = true;
        }
        geocodeHouse(item);
      });



    }


    const geocodeHouse = (house) => {
      //console.log(house)

      let address = `${city} ${house.street} ${house.nr}`;
      console.log("address", address);

      let XHR = new XMLHttpRequest();
      XHR.open("GET", "https://geocode-maps.yandex.ru/1.x/?apikey=ba994d74-1acb-46d7-a398-f7c5eceaa44d&format=json&geocode=" + address);
      XHR.responseType = "json";
      XHR.onload = function () {
        let status = XHR.status;
        if (status !== 200) {
          console.log("status: ", status);
          return;
        }
        //console.log("XHR response ", XHR.response);

        try {
          console.log("CHECK");
          // console.log("geoObj elem-s q-ty", XHR.response.response.GeoObjectCollection.featureMember)
          // console.log("house", house.name.last)
          if (XHR.response.response.GeoObjectCollection.featureMember.length
            && XHR.response.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos) {
            console.log("GET COORDS");
            let coordinates = XHR.response.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" ");
            console.log(coordinates);
            house.point = {
              coordinates: {
                lat: coordinates[1], //внимательно, может переделать
                lon: coordinates[0],
              },
            };
            //console.log(house);
            placehouseOnMap(house);

          } else {
            console.log(`Не могу получить координаты для адреса ${address}`);
          }
        } catch (exception) {
          console.log("Geocode exception", exception);
        }
      };

      XHR.send();

      XHR.onerror = () => {
        console.log(
          `При попытке геокодировать адрес ${address} произошла ошибка.`
        );
      };
    }

    const placehouseOnMap = house => {
      let iconContent = `${house.street} ${house.nr}`;
      let housePoint = new ymaps.GeoObject(
        {
          geometry: {
            type: "Point",
            coordinates: [
              house.point.coordinates.lat,
              house.point.coordinates.lon,
            ],
          },
          properties: {
            iconContent: iconContent,
            hintContent: house.point.address,
            balloonContentBody: `<h3>${house.street} ${house.nr}</h3>`
            //house: house
          },
        },
        {
          preset: "islands#blackStretchyIcon",
        });

      myMap.geoObjects.add(housePoint);

      if (lastHouse) {
        mуMap.setBounds(myMap.geoObjects.getBounds()); // для центровки и зума (чтобы все точки были видны)
      }
    };

    // nameList.sort((bottomItem, upperItem) => {
    //   if (bottomItem.name.last === upperItem.name.last) {
    //     if (bottomItem.name.first > upperItem.name.first) return -1;
    //     else return 0;
    //   } else if (bottomItem.name.last < upperItem.name.last) return -1;
    //   return 0;
    // });

    // let listEl = document.querySelector("#list");

    // nameList.forEach((item) => {
    //   let rowEl = document.createElement("tr");

    //   let fioEl = document.createElement("td");
    //   fioEl.innerText = `${item.name.last} ${item.name.first}`.trim();
    //   rowEl.appendChild(fioEl);

    //   let dobEl = document.createElement("td");
    //   dobEl.innerText = item.birthday === "" ? "unknown" : item.birthday;
    //   rowEl.appendChild(dobEl);

    //   let sexEl = document.createElement("td");
    //   sexEl.innerText =
    //     item.sex === "m" ? "M" : item.sex === "f" ? "Ж" : "unknown";
    //   rowEl.appendChild(sexEl);

    //   let addressEl = document.createElement("td");
    //   addressEl.innerText =
    //     item.point.address === "" ? "неизвестно" : item.point.address;
    //   rowEl.appendChild(addressEl);

    //   listEl.appendChild(rowEl);
    // });
  </script>

</body>

</html>
